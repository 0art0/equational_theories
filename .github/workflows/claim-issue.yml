name: Assign Issue on Claim

on:
  issue_comment:
    types: [created]

jobs:
  claim_issue:
    runs-on: ubuntu-latest

    steps:
    - name: Check if this is an issue, not a pull request
      id: check_issue
      run: |
        if [[ -n "${{ github.event.issue.pull_request }}" ]]; then
          echo "This is a pull request, not an issue."
          exit 0
        fi

    - name: Check if the comment contains exactly "claim"
      id: check_claim
      run: |
        if [[ "${{ github.event.comment.body }}" =~ ^claim$ ]]; then
          echo "exact_claim=true" >> $GITHUB_ENV
        else
          echo "exact_claim=false" >> $GITHUB_ENV
        fi

    - name: Check if issue is already assigned
      if: env.exact_claim == 'true'
      id: check_assignee
      run: |
        ASSIGNEES_COUNT=$(echo "${{ toJson(github.event.issue.assignees) }}" | jq length)
        if [ "$ASSIGNEES_COUNT" -gt 0 ]; then
          echo "Issue is already assigned."
          exit 0
        fi

    - name: Assign the issue to the commenter
      if: env.exact_claim == 'true'
      run: |
        curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        -d '{"assignees":["${{ github.event.comment.user.login }}"]}' \
        https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}

    - name: Log the assignment result
      if: env.exact_claim == 'true'
      run: echo "Issue successfully assigned to ${{ github.event.comment.user.login }}."

    - name: Log when no exact match is found
      if: env.exact_claim == 'false'
      run: echo "The comment does not contain exactly the word 'claim'."
